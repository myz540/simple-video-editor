#!/usr/bin/env python3

import argparse
from loguru import logger

from moviepy.video.io.ffmpeg_tools import ffmpeg_extract_subclip
from moviepy.editor import VideoFileClip
from moviepy.audio.fx.all import volumex


def parse_args():
    parser = argparse.ArgumentParser(
        formatter_class=argparse.ArgumentDefaultsHelpFormatter
    )
    parser.add_argument("video_file")
    sub_parsers = parser.add_subparsers(
        title="commands", help="Available commands and operations"
    )

    # SPLIT VIDEO
    split_video_parser = sub_parsers.add_parser(
        "split_video", help="Split video in chunks of equal length with set overlap"
    )
    split_video_parser.add_argument(
        "--length",
        default=720,
        type=int,
        help="Chunk size (in secs) to split video into",
    )
    split_video_parser.add_argument(
        "--overlap", default=5, type=int, help="Overlap time (in secs) between chunks"
    )
    split_video_parser.set_defaults(func=split_video)

    # SCALE VOLUME
    scale_volume_parser = sub_parsers.add_parser(
        "scale_volume", help="Scale all volume"
    )
    scale_volume_parser.add_argument(
        "--scale-factor",
        default=1.0,
        type=float,
        help="Scale factor, 2 will double the volume while 0.5 will halve it",
    )
    scale_volume_parser.add_argument(
        "--output-file", required=False, help="Scaled output file name"
    )
    scale_volume_parser.set_defaults(func=scale_volume)

    return parser.parse_args()


def split_video(video_file: str, stride: int, overlap: int):
    video = VideoFileClip(video_file)
    video_duration = video.duration
    n_chunks = int(video_duration // stride + 1)

    print(video_duration)
    print(n_chunks)

    logger.info(f"Split video: {video_file}")
    logger.info(
        f"Duration: {video_duration}. Splitting into {n_chunks} chunks of {stride} seconds with {stride} seconds overlap"
    )

    starts = [(i * stride) - overlap for i in range(n_chunks)]

    target_video_file = video_file.replace(".mp4", "_{}.mp4")
    for i, start in enumerate(starts):
        ffmpeg_extract_subclip(
            video_file,
            start,
            start + stride,
            targetname=target_video_file.format(i),
        )


def scale_volume(video_file: str, scale_factor: float, output_file: str = None):
    video = VideoFileClip(video_file)
    video = video.volumex(scale_factor)
    if not output_file:
        output_file = f"scaled_{scale_factor}_{video_file}"
    video.write_videofile(output_file)


if __name__ == "__main__":
    args = vars(parse_args())
    print(args)
    func = args.pop("func")
    func(**args)
